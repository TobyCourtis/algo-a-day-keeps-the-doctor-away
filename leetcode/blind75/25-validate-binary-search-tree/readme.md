Initial attempt:

Messy but sound logic. DFS - see code for explanation on lower and upper bound which is the only complexity here.

Beat 99% runtime, 80% memory